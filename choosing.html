<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>御膳翻牌器 - 皇家钦点</title>
    <style>
        :root {
            --gold-primary: #d4af37;
            --gold-secondary: #b8941f;
            --gold-light: #f8e7b6;
            --red-royal: #c53d2f;
            --red-dark: #a52a2a;
            --bg-cream: #fff9e6;
            --bg-paper: #f9f3e5;
            --text-dark: #5c3317;
            --text-light: #8b4513;
            --border-gold: #d4af37;
            --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Serif SC', 'SimSun', serif;
            background-color: var(--bg-paper);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 15px;
            max-width: 1000px;
            margin: 0 auto;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d4af37' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
            color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--gold-primary);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        h2 {
            font-size: 1.5rem;
            margin: 15px 0 10px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--gold-light);
            padding-bottom: 5px;
        }

        h3 {
            font-size: 1.3rem;
            margin: 12px 0 8px;
            color: var(--text-dark);
        }

        h4 {
            font-size: 1.1rem;
            margin: 10px 0;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .plan-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gold-light);
        }

        .plan-selector label {
            font-weight: bold;
            color: var(--text-dark);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--gold-light);
            border-radius: 5px;
            background: white;
            color: var(--text-dark);
            font-size: 1rem;
            min-width: 200px;
        }

        .plans-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gold-light);
        }

        .plan {
            background-color: var(--bg-cream);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gold-light);
        }

        .category {
            background-color: white;
            border-left: 4px solid var(--gold-primary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
        }

        .category-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--gold-light);
        }

        .category-name {
            min-width: 120px;
            padding: 8px;
            border: 1px solid var(--gold-light);
            border-radius: 4px;
            font-size: 1rem;
            background: var(--bg-cream);
        }

        .item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-cream);
            border-radius: 5px;
            border: 1px solid var(--gold-light);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-name {
            flex-grow: 1;
            padding: 6px 10px;
            border: 1px solid var(--gold-light);
            border-radius: 4px;
            font-size: 1rem;
            background: white;
            min-width: 150px;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .weight-label {
            font-weight: bold;
            color: var(--text-dark);
        }

        .count-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-right: 10px;
        }

        .count-label {
            font-weight: bold;
            color: var(--text-dark);
        }

        button {
            background-color: var(--gold-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: var(--gold-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background-color: #8b7d6b;
        }

        button.danger {
            background-color: var(--red-royal);
        }

        button.danger:hover {
            background-color: var(--red-dark);
        }

        button.large {
            padding: 16px 48px;
            font-size: 1.2rem;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid var(--gold-light);
            border-radius: 4px;
            background: white;
            color: var(--text-dark);
            font-size: 1rem;
        }

        input[type="number"] {
            width: 70px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .add-button-container {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }

        .draw-button-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--gold-primary);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .result-item {
            padding: 10px;
            margin: 8px 0;
            background-color: var(--bg-cream);
            border-radius: 5px;
            border-left: 3px solid var(--gold-primary);
        }

        .history-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gold-light);
        }

        .history-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: var(--bg-cream);
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gold-light);
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #8b7d6b;
            font-style: italic;
        }

        .target-option {
            padding: 10px;
            margin: 5px 0;
            background-color: var(--bg-cream);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .target-option:hover {
            background-color: var(--gold-light);
        }

        .target-option.selected {
            background-color: var(--gold-primary);
            color: white;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }

            .plan-selector {
                width: 100%;
                justify-content: center;
            }

            select {
                min-width: 150px;
            }

            .category-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .item-controls {
                width: 100%;
                justify-content: space-between;
            }

            #plan-details > div > div > h3 {
                width: 76%;
                text-align: left;
            }

            #plan-details > div > div > div > div > div > div > input {
                width: 100%;
            }

            #plan-details > div > div > h3 > input {
                min-width: 200px;
                /*text-align: center;*/
                width: 100%
            }

            #plan-details > div {
                padding: 5px;
            }

            body > div.container > div.plans-container, body {
                padding: 10px;
            }

            #plan-details > div > div > div > div.category-header > input {
                text-align: center;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>御膳翻牌器</h1>
    <p>天子用膳，不怕困难</p>
</header>

<div class="container">
    <div class="draw-button-container">
        <button id="draw-meal" class="large">翻牌子</button>
    </div>

    <!--    <div class="add-button-container">-->
    <!--    </div>-->
    <div></div>

    <div class="plan-selector"
         style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap;text-align: right">
        <!--            <label for="plan-select">当前方案:</label>-->
        <label for="plan-select">看朕心情择膳：</label>
        <select id="plan-select"></select>
        <button id="add-plan">新增膳方</button>
        <button onclick="copyPlan(`${state.currentPlanId}`)">再制本方</button>
        <button onclick="requestDeletePlan(`${state.currentPlanId}`)" class="danger">焚毁膳方</button>
    </div>

    <div class="plans-container">
        <!--        <h2>膳方详情</h2>-->
        <div id="plan-details">
            <!-- 方案详情将由JS动态生成 -->
            <div class="empty-state">请选择或创建膳方</div>
        </div>
    </div>

    <div class="controls-row">
        <button id="import-btn">换新御方</button>
        <button id="export-btn">誊出御方</button>
    </div>

    <div class="history-container">
        <h2>近期膳注</h2>
        <div id="history-list">
            <!-- 历史记录将由JS动态生成 -->
            <div class="empty-state">暂无用膳记录</div>
        </div>
        <div class="add-button-container">
            <button id="clear-history" class="secondary">来人，把这焚了</button>
        </div>
    </div>
</div>

<!-- 翻牌结果模态框 -->
<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2>今日御膳</h2>
        <div id="result-content"></div>
        <div class="modal-buttons">
            <button id="confirm-result">吩咐下去</button>
            <button id="cancel-result" class="secondary">朕不喜欢</button>
        </div>
    </div>
</div>

<!-- 移动类部模态框 -->
<div id="move-category-modal" class="modal">
    <div class="modal-content">
        <h2>奉天承运，皇帝诏曰</h2>
        <p>将类部 "<span id="moving-category-name"></span>" 即刻移动到:</p>
        <div id="target-plan-list" style="margin: 15px 0;"></div>
        <div class="modal-buttons">
            <button id="confirm-move-category">君无戏言</button>
            <button id="cancel-move-category" class="secondary">适才相戏耳</button>
        </div>
    </div>
</div>

<!-- 移动膳品模态框 -->
<div id="move-item-modal" class="modal">
    <div class="modal-content">
        <h2>奉天承运，皇帝诏曰</h2>
        <p>将膳品 "<span id="moving-item-name"></span>" 即刻移动到:</p>
        <div id="target-category-list" style="margin: 15px 0;"></div>
        <div class="modal-buttons">
            <button id="confirm-move-item">君无戏言</button>
            <button id="cancel-move-item" class="secondary">适才相戏耳</button>
        </div>
    </div>
</div>

<!-- 复制类部模态框 -->
<div id="copy-category-modal" class="modal">
    <div class="modal-content">
        <h2>奉天承运，皇帝诏曰</h2>
        <p>将类部 "<span id="copying-category-name"></span>" 即刻抄送到:</p>
        <div id="target-copy-plan-list" style="margin: 15px 0;"></div>
        <div class="modal-buttons">
            <button id="confirm-copy-category">君无戏言</button>
            <button id="cancel-copy-category" class="secondary">适才相戏耳</button>
        </div>
    </div>
</div>

<!-- 备注模态框 -->
<div id="note-modal" class="modal">
    <div class="modal-content">
        <h2>传口谕</h2>
        <textarea id="note-input" rows="4"
                  style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd;"></textarea>
        <div class="modal-buttons">
            <button id="save-note">宣下去</button>
            <button id="cancel-note" class="secondary">不必了</button>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <h2>陛下三思</h2>
        <p id="confirm-message">罪臣万请陛下三思啊！</p>
        <div class="modal-buttons">
            <button id="confirm-yes">再拦赐死</button>
            <button id="confirm-no" class="secondary">这回朕依你</button>
        </div>
    </div>
</div>

<!-- 导入导出模态框 -->
<div id="import-export-modal" class="modal">
    <div class="modal-content">
        <h2 id="ie-title">导入御方</h2>
        <textarea id="ie-textarea" rows="10"
                  style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd;"></textarea>
        <div class="modal-buttons">
            <button id="ie-action">君无戏言</button>
            <button id="ie-cancel" class="secondary">适才相戏耳</button>
        </div>
    </div>
</div>

<script>
    // 数据结构定义
    let state = {
        plans: [],
        currentPlanId: null,
        history: [],
        undoStacks: {}, // 每个方案的撤销栈，保存了每次操作时膳方状态的全量信息，可优化为增量
        redoStacks: {}  // 每个方案的重做栈
    };

    // 全局变量用于确认操作
    let confirmedCallback = null;
    let currentResults = null;
    let currentPlanForResults = null;

    // 全局变量，用于存储移动/复制操作的相关信息
    let targetPlanId = null;
    let targetCategoryId = null;
    let copyingCategoryId = null;
    let movingCategoryId = null;
    let movingItemId = null;

    // 设定膳品模版
    let noneDataItem = {id: 0, name: "膳品", weight: 100};
    let defaultItem = noneDataItem;

    // 设定类部模版
    let noneDataCategory = {
        id: 0,
        name: "类部",
        count: 1,
        allowRepeat: false,
        items: [defaultItem]
    };
    let defaultCategory = noneDataCategory;

    // 设定几种方案模版，有数据、空数据、初始化方案、默认方案
    let initDataPlan = {
        id: 0,
        name: `平静的晚膳`,
        categories: [
            {
                id: 0,
                name: "主食",
                count: 1,
                allowRepeat: false,
                items: [
                    {id: 0, name: "馒头", weight: 100}
                ]
            },
            {
                id: 0,
                name: "配菜",
                count: 1,
                allowRepeat: false,
                items: [
                    {id: 0, name: "小鸡炖蘑菇", weight: 100}
                ]
            },
            {
                id: 0,
                name: "点心",
                count: 1,
                allowRepeat: false,
                items: [
                    {id: 0, name: "橘子", weight: 100},
                    {id: 0, name: "爆米花", weight: 100}
                ]
            },
            {
                id: 0,
                name: "饮品",
                count: 1,
                allowRepeat: false,
                items: [
                    {id: 0, name: "小米粥", weight: 100}
                ]
            }
        ]
    };
    let noneDataPlan = {
        id: 0,
        name: `用膳方案`,
        categories: [defaultCategory]
    };
    let initPlans = [initDataPlan, initDataPlan]; // 初次打开程序使用的方案
    let defaultPlan = initPlans[0]; // 新建方案使用的模版

    // 初始化函数
    function init() {
        loadData();
        render();
        setupEventListeners();
    }

    // 从localStorage加载数据
    function loadData() {
        const saved = localStorage.getItem('mealSelectorData');
        if (saved) {
            const data = JSON.parse(saved);
            state.plans = data.plans || [];
            state.history = data.history || [];
            state.undoStacks = data.undoStacks || {};
            state.redoStacks = data.redoStacks || {};

            // 设置当前方案，打开上次膳方
            if (state.plans.length > 0) {
                state.currentPlanId = data.currentPlanId;
            }
        } else {
            // localStorage无数据，初始化默认数据
            state.currentPlanId = null;
            state.plans = [];
            state.history = [];
            state.redoStacks = {};
            state.undoStacks = {};
            initPlans.forEach(plan => {
                plan = copyPlanData(plan)
                state.plans.push(plan);
                state.currentPlanId = plan.id;
                state.undoStacks[plan.id] = [];
                state.redoStacks[plan.id] = [];
            })
            saveState();
        }
    }

    // 保存数据到localStorage
    function saveState() {
        localStorage.setItem('mealSelectorData', JSON.stringify(state));
    }

    // 渲染界面
    function render() {
        renderPlanSelector();
        renderPlanDetails();
        renderHistory();
    }

    // 渲染方案选择器
    function renderPlanSelector() {
        const planSelect = document.getElementById('plan-select');
        planSelect.innerHTML = '';

        state.plans.forEach(plan => {
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = plan.name;
            option.selected = (plan.id === state.currentPlanId);
            planSelect.appendChild(option);
        });
    }

    // 渲染方案详情
    function renderPlanDetails() {
        const planDetails = document.getElementById('plan-details');

        if (!state.currentPlanId || state.plans.length === 0) {
            planDetails.innerHTML = '<div class="empty-state">请选择或创建膳方</div>';
            return;
        }

        const plan = state.plans.find(p => p.id === state.currentPlanId);
        if (!plan) return;

        planDetails.innerHTML = `
                <div class="plan">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <h3>
                            <input type="text" class="category-name" value="${plan.name}"
                                onchange="renamePlan('${plan.id}', this.value)" style="min-width: 200px;">
                        </h3>
                        <div>
                            <button onclick="undo('${plan.id}')"
                                ${state.undoStacks[plan.id] && state.undoStacks[plan.id].length > 0 ? '' :
            ` disabled style="background: #b8941f" `}><</button>
                            <button onclick="redo('${plan.id}')"
                                ${state.redoStacks[plan.id] && state.redoStacks[plan.id].length > 0 ? '' :
            ' disabled style="background: #b8941f" '}>></button>
                        </div>
                    </div>
                    <div id="categories-${plan.id}">
                        ${renderCategories(plan)}
                    </div>
                    <div class="add-button-container">
                        <button onclick="addCategory('${plan.id}')">新增类部</button>
                    </div>
                </div>
            `;
    }

    // 渲染类部
    function renderCategories(plan) {
        if (!plan.categories || plan.categories.length === 0) {
            return '<div class="empty-state">此类部为空，点击"新增类部"添加</div>';
        }

        let html = '';
        plan.categories.forEach(category => {
            html += `
                    <div class="category">
                        <div class="category-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                            <input type="text" class="category-name" value="${category.name}"
                                onchange="renameCategory('${plan.id}', '${category.id}', this.value)">
                            <label>
                                <input type="checkbox" ${category.allowRepeat ? 'checked' : ''}
                                    onchange="toggleCategoryRepeat('${plan.id}', '${category.id}', this.checked)">
                                叠膳
                            </label>
                            <div class="count-control">
                                <button onclick="adjustCategoryCount('${plan.id}', '${category.id}', -1)">-</button>
                                <input type="number" min="0" max="10000" value="${category.count}"
                                    onchange="updateCategoryCount('${plan.id}', '${category.id}', this.value)">
                                <button onclick="adjustCategoryCount('${plan.id}', '${category.id}', 1)">+</button>
                                <span class="count-label">份</span>
                            </div>
                            <div>
                                <button onclick="moveCategoryToPlan('${plan.id}', '${category.id}')">移</button>
                                <button onclick="copyCategoryToPlan('${plan.id}', '${category.id}')">抄</button>
                                <button onclick="requestDeleteCategory('${plan.id}', '${category.id}')" class="danger">×</button>
                            </div>
                        </div>
                        <div id="items-${category.id}">
                            ${renderItems(plan.id, category)}
                        </div>
                        <div class="add-button-container">
                            <button onclick="addItem('${plan.id}', '${category.id}')">添加膳品</button>
                        </div>
                    </div>
                `;
        });

        return html;
    }

    // 渲染膳品项
    function renderItems(planId, category) {
        if (!category.items || category.items.length === 0) {
            return '<div class="empty-state">此类部暂无膳品，点击"添加膳品"</div>';
        }

        let html = '';
        category.items.forEach(item => {
            html += `
                    <div class="item">
                        <div class="item-header">
                            <input type="text" class="item-name" value="${item.name}"
                                onchange="renameItem('${planId}', '${category.id}', '${item.id}', this.value)">
                            <div class="item-controls">
                                <div class="weight-control">
                                    <span class="weight-label">权:</span>
                                    <button onclick="adjustItemWeight('${planId}', '${category.id}', '${item.id}', -1)">-</button>
                                    <input type="number" min="0" max="10000" value="${item.weight}"
                                        onchange="updateItemWeight('${planId}', '${category.id}', '${item.id}', this.value)">
                                    <button onclick="adjustItemWeight('${planId}', '${category.id}', '${item.id}', 1)">+</button>
                                </div>
                                <div>
                                    <button onclick="moveItemToCategory('${planId}', '${category.id}', '${item.id}')">移</button>
                                    <button onclick="requestDeleteItem('${planId}', '${category.id}', '${item.id}')" class="danger">×</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });

        return html;
    }

    // 渲染历史记录
    function renderHistory() {
        const historyList = document.getElementById('history-list');

        if (state.history.length === 0) {
            historyList.innerHTML = '<div class="empty-state">暂无用膳记录</div>';
            return;
        }

        // 只显示最近10条记录
        const recentHistory = state.history.slice(-10).reverse();

        historyList.innerHTML = '';
        recentHistory.forEach(record => {
            const historyElement = document.createElement('div');
            historyElement.className = 'history-item';

            let resultsHtml = '';
            for (const [category, items] of Object.entries(record.results)) {
                resultsHtml += `<div><strong>${category}:</strong> ${items.join(', ')}</div>`;
            }

            historyElement.innerHTML = `
                    <div><strong>${new Date(record.time).toLocaleString()}</strong></div>
                    <div>膳方: ${record.planName}</div>
                    ${resultsHtml}
                    ${record.note ? `<div><strong>口谕:</strong> ${record.note}</div>` : ''}
                `;

            historyList.appendChild(historyElement);
        });
    }

    // 设置事件监听器
    function setupEventListeners() {
        // 方案选择器
        document.getElementById('plan-select').addEventListener('change', (e) => {
            setCurrentPlan(e.target.value);
        });

        // 添加方案按钮
        document.getElementById('add-plan').addEventListener('click', addNewPlan);

        // 翻牌按钮
        document.getElementById('draw-meal').addEventListener('click', () => {
            if (state.currentPlanId) {
                drawMeal(state.currentPlanId);
            } else {
                alert('请先选择或创建一个用膳方案');
            }
        });

        // 导入按钮
        document.getElementById('import-btn').addEventListener('click', () => {
            showImportExportModal('导入御方', '导入', importData);
        });

        // 导出按钮
        document.getElementById('export-btn').addEventListener('click', () => {
            const data = prepareExportData();
            showImportExportModal('导出御方', '复制', exportData, JSON.stringify(data, null, 2));
        });

        // 清除历史按钮
        document.getElementById('clear-history').addEventListener('click', requestClearHistory);

        // 移动类部模态框事件
        document.getElementById('confirm-move-category').addEventListener('click', executeMoveCategory);
        document.getElementById('cancel-move-category').addEventListener('click', () => {
            document.getElementById('move-category-modal').style.display = 'none';
        });

        // 移动膳品模态框事件
        document.getElementById('confirm-move-item').addEventListener('click', executeMoveItem);
        document.getElementById('cancel-move-item').addEventListener('click', () => {
            document.getElementById('move-item-modal').style.display = 'none';
        });

        // 复制类部模态框事件
        document.getElementById('confirm-copy-category').addEventListener('click', executeCopyCategory);
        document.getElementById('cancel-copy-category').addEventListener('click', () => {
            document.getElementById('copy-category-modal').style.display = 'none';
        });

        // 模态框按钮
        setupModalEvents();
    }

    // 设置模态框事件
    function setupModalEvents() {
        // 结果模态框
        document.getElementById('confirm-result').addEventListener('click', confirmResult);
        document.getElementById('cancel-result').addEventListener('click', () => {
            document.getElementById('result-modal').style.display = 'none';
        });

        // 备注模态框
        document.getElementById('save-note').addEventListener('click', saveNote);
        document.getElementById('cancel-note').addEventListener('click', () => {
            document.getElementById('note-modal').style.display = 'none';
            addToHistory(currentResults, '');
        });

        // 确认模态框
        document.getElementById('confirm-yes').addEventListener('click', executeConfirmedAction);
        document.getElementById('confirm-no').addEventListener('click', () => {
            document.getElementById('confirm-modal').style.display = 'none';
        });

        // 导入导出模态框
        document.getElementById('ie-action').addEventListener('click', executeIEAction);
        document.getElementById('ie-cancel').addEventListener('click', () => {
            document.getElementById('import-export-modal').style.display = 'none';
        });
    }

    // 显示导入导出模态框
    function showImportExportModal(title, actionText, actionHandler, content = '') {
        document.getElementById('ie-title').textContent = title;
        document.getElementById('ie-action').textContent = actionText;
        document.getElementById('ie-textarea').value = content;

        const modal = document.getElementById('import-export-modal');
        modal.style.display = 'flex';
        modal.dataset.action = actionHandler.name;

        if (content) {
            document.getElementById('ie-textarea').select();
        }
    }

    // 执行导入导出操作
    function executeIEAction() {
        const action = document.getElementById('import-export-modal').dataset.action;
        const text = document.getElementById('ie-textarea').value;

        if (action === importData.name) {
            importData(text);
        } else if (action === exportData.name) {
            exportData(text);
        }

        document.getElementById('import-export-modal').style.display = 'none';
    }

    // 导入数据
    function importData(text) {
        if (!text) {
            // 重置
            const y = confirm('确认清除包括膳方、膳注在内的所有膳方，并重新初始化吗？');
            if (y) {
                localStorage.removeItem('mealSelectorData');
                init();
                alert('启禀陛下，重置完成');
            } else {
                alert('皇上圣明');
            }
            return;
        }
        try {
            const data = JSON.parse(text);
            // 验证数据格式
            if (data.plans && Array.isArray(data.plans)) {
                const y = confirm('新御方数据包含膳方，确定导入并覆盖本机所有膳方吗？');
                if (y) {
                    state.plans = data.plans;
                    // 撤销重做栈不能分开导入，且必须和膳方同时导入
                    let yy = false;
                    if (data.undoStacks && data.redoStacks) {
                        yy = confirm('新御方数据还包含撤销重做记录，是否同时导入？')
                    }
                    if (yy) {
                        state.undoStacks = data.undoStacks;
                        state.redoStacks = data.redoStacks;
                    } else {
                        state.undoStacks = {};
                        state.redoStacks = {};
                    }
                }
            }
            if (data.history && Array.isArray(data.history)) {
                const y = confirm('新御方数据包含膳注，确定导入并覆盖本机所有膳注吗？');
                if (y) {
                    state.history = data.history;
                }
            }
            if (data.currentPlanId) {
                state.currentPlanId = data.currentPlanId;
            } else if (state.plans.length > 0) {
                state.currentPlanId = state.plans[0].id;
            }

            saveState();
            render();
            alert('导入成功！');
        } catch (e) {
            alert('导入失败：无效的JSON格式');
        }
    }

    // 准备导出数据
    function prepareExportData() {
        return {
            currentPlanId: state.currentPlanId,
            plans: state.plans,
            history: state.history,
            undoStacks: state.undoStacks,
            redoStacks: state.redoStacks
        };
    }

    // 导出数据
    function exportData(text) {
        try {
            navigator.clipboard.writeText(text);
            alert('御方已复制到剪贴板');
        } catch (e) {
            alert('复制失败，请手动复制文本');
        }
    }

    // 添加新方案
    function addNewPlan() {
        const plan = copyPlanData(defaultPlan, state.plans.length + 1)
        state.plans.push(plan);
        state.undoStacks[plan.id] = [];
        state.redoStacks[plan.id] = [];

        setCurrentPlan(plan.id);
        render();
        focusOn(`#plan-details > div > div:nth-child(1) > h3 > input`);
    }

    // 重命名方案
    function renamePlan(planId, newName) {
        newName = newName.trim();
        if (!newName) {
            alert('请陛下为膳方赐名');
            render();
            return;
        }

        // 检查名称是否已存在
        if (state.plans.some(p => p.name === newName)) {
            alert('陛下神机妙算，这道膳方已经有了');
            // render();
            return;
        }

        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            // saveStateToStack(planId);  方案名改动入栈会导致重名
            plan.name = newName;
            saveState();
            renderPlanSelector();
            renderPlanDetails();
        }
    }

    // 复制方案
    function copyPlan(planId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const copiedPlan = copyPlanData(plan, '新');
            state.plans.push(copiedPlan);
            state.undoStacks[copiedPlan.id] = [];
            state.redoStacks[copiedPlan.id] = [];
            setCurrentPlan(copiedPlan.id)
            render();
            focusOn(`#plan-details > div > div:nth-child(1) > h3 > input`);
        }
    }

    // 方案数据拷贝
    function copyPlanData(plan, namePostfix = '') {
        // 深拷贝
        const copiedPlan = JSON.parse(JSON.stringify(plan));
        copiedPlan.id = generateId();
        copiedPlan.name = `${plan.name}${namePostfix}`;
        // 为所有子类部生成新ID
        copiedPlan.categories.forEach(regenerateCategoryId);
        return copiedPlan;
    }

    // 请求删除方案
    function requestDeletePlan(planId) {
        showConfirmModal('膳方得来不易，焚毁就找不回了，陛下忍心吗？', () => {
            deletePlan(planId);
        });
    }

    // 删除方案
    function deletePlan(planId) {
        const index = state.plans.findIndex(p => p.id === planId);
        if (index !== -1) {
            state.plans.splice(index, 1);

            // 如果删除的是当前方案，切换到前一个方案
            if (state.currentPlanId === planId) {
                state.currentPlanId = state.plans.length > 0 ? state.plans[index === 0 ? 0 : index - 1].id : null;
            }

            // 清除相关的撤销重做栈
            delete state.undoStacks[planId];
            delete state.redoStacks[planId];

            saveState();
            render();
        }
    }

    // 设置当前方案
    function setCurrentPlan(planId) {
        state.currentPlanId = planId;
        saveState();
        renderPlanDetails();
    }

    // 添加类部
    function addCategory(planId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const newCategory = copyCategoryData(defaultCategory, plan.categories.length + 1);
            saveStateToStack(planId);
            plan.categories.push(newCategory);
            saveState();
            renderPlanDetails();
            focusOn(`#categories-${plan.id} > div:nth-child(${plan.categories.length}) > div.category-header > input`);
        }
    }

    // 重命名类部
    function renameCategory(planId, categoryId, newName) {
        newName = newName.trim();
        if (!newName) {
            alert('奏请陛下为类部赐名！');
            renderPlanDetails();
            return;
        }

        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                // 检查名称是否已存在
                if (plan.categories.some(c => c.name === newName)) {
                    alert('回陛下，这个类部已经有了');
                    // renderPlanDetails();
                    return;
                }

                saveStateToStack(planId);
                category.name = newName;
                saveState();
                renderPlanDetails();
            }
        }
    }

    // 更新类部数量
    function updateCategoryCount(planId, categoryId, count) {
        count = parseInt(count);
        if (isNaN(count) || count < 0 || count > 10000) {
            alert('份数必须在0-10000之间');
            renderPlanDetails();
            return;
        }

        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                saveStateToStack(planId);
                category.count = count;
                saveState();
            }
        }
    }

    // 调整类部数量
    function adjustCategoryCount(planId, categoryId, delta) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                let count = category.count + delta;
                if (count < 0) count = 0;
                if (count > 10000) count = 10000;
                saveStateToStack(planId);
                category.count = count;
                saveState();
                renderPlanDetails();
            }
        }
    }

    // 切换膳品是否可重复
    function toggleCategoryRepeat(planId, categoryId, allowRepeat) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                saveStateToStack(planId);
                category.allowRepeat = allowRepeat;
                saveState();
            }
        }
    }

    // 移动类部到其他方案的弹窗
    function moveCategoryToPlan(planId, categoryId) {
        const plan = state.plans.find(p => p.id === planId);
        if (!plan) return;

        const category = plan.categories.find(c => c.id === categoryId);
        if (!category) return;

        movingCategoryId = categoryId;
        document.getElementById('moving-category-name').textContent = category.name;

        // 填充目标方案列表
        const targetPlanList = document.getElementById('target-plan-list');
        targetPlanList.innerHTML = '';

        state.plans.forEach(p => {
            if (p.id !== planId) { // 不能移动到当前方案
                const div = document.createElement('div');
                div.className = 'target-option';
                div.dataset.planId = p.id;
                div.textContent = p.name;
                div.addEventListener('click', function () {
                    // 移除之前的选择
                    document.querySelectorAll('#target-plan-list .target-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // 选中当前项
                    this.classList.add('selected');
                    targetPlanId = this.dataset.planId;
                });
                targetPlanList.appendChild(div);
            }
        });

        if (targetPlanList.children.length === 0) {
            targetPlanList.innerHTML = '<div class="empty-state">启禀陛下，现无他方了</div>';
        }

        // 显示模态框
        document.getElementById('move-category-modal').style.display = 'flex';
        targetPlanId = null;
    }

    // 执行移动类部
    function executeMoveCategory() {
        if (!targetPlanId) {
            alert('陛下明断，未选目标膳方');
            return;
        }

        const sourcePlan = state.plans.find(p => p.categories.some(c => c.id === movingCategoryId));
        const targetPlan = state.plans.find(p => p.id === targetPlanId);

        if (!sourcePlan || !targetPlan) return;

        const categoryIndex = sourcePlan.categories.findIndex(c => c.id === movingCategoryId);
        if (categoryIndex === -1) return;

        const category = sourcePlan.categories[categoryIndex];

        // 检查目标方案中是否已有同名类部
        if (targetPlan.categories.some(c => c.name === category.name)) {
            alert('启禀陛下，目标膳方有此类部，请先赐名再移动');
            return;
        }

        // 从源方案移除
        sourcePlan.categories.splice(categoryIndex, 1);
        // 添加到目标方案
        targetPlan.categories.push(category);

        // 保存状态
        saveState();
        saveStateToStack(sourcePlan.id);
        saveStateToStack(targetPlan.id);

        // 关闭模态框
        document.getElementById('move-category-modal').style.display = 'none';

        // 刷新界面
        render();
    }

    // 复制类部到其他方案的弹窗
    function copyCategoryToPlan(planId, categoryId) {
        const plan = state.plans.find(p => p.id === planId);
        if (!plan) return;
        const category = plan.categories.find(c => c.id === categoryId);
        if (!category) return;
        copyingCategoryId = categoryId;
        document.getElementById('copying-category-name').textContent = category.name;

        // 填充目标方案列表
        const targetPlanList = document.getElementById('target-copy-plan-list');
        targetPlanList.innerHTML = '';
        state.plans.forEach(p => {
            const div = document.createElement('div');
            div.className = 'target-option';
            div.dataset.planId = p.id;
            div.textContent = p.name;
            div.addEventListener('click', function () {
                // 移除之前的选择
                document.querySelectorAll('#target-copy-plan-list .target-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                // 选中当前项
                this.classList.add('selected');
                targetPlanId = this.dataset.planId;
            });
            targetPlanList.appendChild(div);
        });

        // 显示模态框
        document.getElementById('copy-category-modal').style.display = 'flex';
        targetPlanId = null;
    }

    // 执行复制类部
    function executeCopyCategory() {
        if (!targetPlanId) {
            alert('陛下明断，未选目标膳方');
            return;
        }
        const sourcePlan = state.plans.find(p => p.categories.some(c => c.id === copyingCategoryId));
        const targetPlan = state.plans.find(p => p.id === targetPlanId);
        if (!sourcePlan || !targetPlan) return;
        const category = sourcePlan.categories.find(c => c.id === copyingCategoryId);
        if (!category) return;

        // 深拷贝类部，且重新生成ID
        const copiedCategory = copyCategoryData(category, ` 抄${sourcePlan.name}`);

        // 检查目标方案中是否已有同名类部
        if (targetPlan.categories.some(c => c.name === copiedCategory.name)) {
            // 添加后缀以保持名称唯一
            let counter = 1;
            while (targetPlan.categories.some(c => c.name === `${copiedCategory.name} ${counter}`)) {
                counter++;
            }
            copiedCategory.name = `${copiedCategory.name} ${counter}`;
        }

        // 添加到目标方案，操作栈保存
        saveStateToStack(targetPlan.id);
        targetPlan.categories.push(copiedCategory);

        // 保存状态
        saveState();
        // 关闭模态框
        document.getElementById('copy-category-modal').style.display = 'none';
        // 切换到目标方案并聚焦到新复制类目
        setCurrentPlan(targetPlanId);
        render();
        focusOn(`#categories-${targetPlanId} > div:nth-child(${targetPlan.categories.length}) > div.category-header > input`);
    }

    // 类部数据拷贝
    function copyCategoryData(category, namePostfix = '') {
        // 深拷贝类部
        const copiedCategory = JSON.parse(JSON.stringify(category));
        copiedCategory.name = `${category.name}${namePostfix}`;
        regenerateCategoryId(copiedCategory);
        return copiedCategory;
    }

    // 类部及其内膳品重新生成ID
    function regenerateCategoryId(category) {
        category.id = generateId();
        category.items.forEach(item => {
            item.id = generateId();
        });
    }

    // 请求删除类部
    function requestDeleteCategory(planId, categoryId) {
        deleteCategory(planId, categoryId);
        // showConfirmModal('创立之时，六部九卿无不曾为此夙兴夜寐，陛下真愿舍去此类部吗？', () => {
        // });
    }

    // 删除类部
    function deleteCategory(planId, categoryId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const index = plan.categories.findIndex(c => c.id === categoryId);
            if (index !== -1) {
                saveStateToStack(planId);
                plan.categories.splice(index, 1);
                saveState();
                renderPlanDetails();
            }
        }
    }

    // 添加膳品
    function addItem(planId, categoryId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                const newItem = JSON.parse(JSON.stringify(defaultItem));
                newItem.id = generateId();
                newItem.name = `${defaultItem.name}${category.items.length + 1}`;

                saveStateToStack(planId);
                category.items.push(newItem);
                saveState();
                renderPlanDetails();
                focusOn(`#items-${category.id} > div:nth-child(${category.items.length}) > div > input`);
            }
        }
    }

    function focusOn(selector) {
        let element = document.querySelector(selector);
        element.placeholder = element.value
        element.value = ''
        if (element) {
            element.focus();
        }
    }

    // 重命名膳品
    function renameItem(planId, categoryId, itemId, newName) {
        newName = newName.trim();
        if (!newName) {
            alert('奏请陛下为膳品赐名');
            renderPlanDetails();
            return;
        }

        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                const item = category.items.find(i => i.id === itemId);
                if (item) {
                    // 检查名称是否已存在
                    if (category.items.some(i => i.name === newName)) {
                        alert('回陛下，这膳品已经有了');
                        // renderPlanDetails();
                        return;
                    }

                    saveStateToStack(planId);
                    item.name = newName;
                    saveState();
                    renderPlanDetails();
                }
            }
        }
    }

    // 调整膳品权重
    function adjustItemWeight(planId, categoryId, itemId, delta) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                const item = category.items.find(i => i.id === itemId);
                if (item) {
                    let newWeight = item.weight + delta;
                    if (newWeight < 0) newWeight = 0;
                    if (newWeight > 10000) newWeight = 10000;

                    saveStateToStack(planId);
                    item.weight = newWeight;
                    saveState();
                    renderPlanDetails();
                }
            }
        }
    }

    // 更新膳品权重
    function updateItemWeight(planId, categoryId, itemId, weight) {
        weight = parseInt(weight);
        if (isNaN(weight) || weight < 0 || weight > 10000) {
            alert('权重须在0-10000之间');
            renderPlanDetails();
            return;
        }

        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                const item = category.items.find(i => i.id === itemId);
                if (item) {
                    saveStateToStack(planId);
                    item.weight = weight;
                    saveState();
                }
            }
        }
    }

    // 移动膳品到其他类部的弹窗
    function moveItemToCategory(planId, categoryId, itemId) {
        const plan = state.plans.find(p => p.id === planId);
        if (!plan) return;

        const sourceCategory = plan.categories.find(c => c.id === categoryId);
        if (!sourceCategory) return;

        const item = sourceCategory.items.find(i => i.id === itemId);
        if (!item) return;

        movingItemId = itemId;
        document.getElementById('moving-item-name').textContent = item.name;

        // 填充目标类部列表
        const targetCategoryList = document.getElementById('target-category-list');
        targetCategoryList.innerHTML = '';

        state.plans.forEach(p => {
            p.categories.forEach(c => {
                // 不能移动到原类部
                if (c.id !== categoryId) {
                    const div = document.createElement('div');
                    div.className = 'target-option';
                    div.dataset.planId = p.id;
                    div.dataset.categoryId = c.id;
                    div.textContent = `${p.name} - ${c.name}`;
                    div.addEventListener('click', function () {
                        // 移除之前的选择
                        document.querySelectorAll('#target-category-list .target-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // 选中当前项
                        this.classList.add('selected');
                        targetPlanId = this.dataset.planId;
                        targetCategoryId = this.dataset.categoryId;
                    });
                    targetCategoryList.appendChild(div);
                }
            });
        });

        if (targetCategoryList.children.length === 0) {
            targetCategoryList.innerHTML = '<div class="empty-state">启禀陛下，现无他类</div>';
        }

        // 显示模态框
        document.getElementById('move-item-modal').style.display = 'flex';
        targetPlanId = null;
        targetCategoryId = null;
    }

    // 执行移动膳品
    function executeMoveItem() {
        if (!targetPlanId || !targetCategoryId) {
            alert('陛下明断，未选目标类部');
            return;
        }

        // 查找源类部
        let sourceCategory = null;
        let sourcePlan = null;

        for (const plan of state.plans) {
            for (const category of plan.categories) {
                if (category.items.some(i => i.id === movingItemId)) {
                    sourceCategory = category;
                    sourcePlan = plan;
                    break;
                }
            }
            if (sourceCategory) break;
        }

        if (!sourceCategory || !sourcePlan) return;

        // 查找目标类部
        const targetPlan = state.plans.find(p => p.id === targetPlanId);
        if (!targetPlan) return;

        const targetCategory = targetPlan.categories.find(c => c.id === targetCategoryId);
        if (!targetCategory) return;

        const itemIndex = sourceCategory.items.findIndex(i => i.id === movingItemId);
        if (itemIndex === -1) return;

        const item = sourceCategory.items[itemIndex];

        // 检查目标类部中是否已有同名膳品
        if (targetCategory.items.some(i => i.name === item.name)) {
            alert('启禀陛下，目标类部有此膳品，请先赐名再移动');
            return;
        }

        // 从源类部移除
        sourceCategory.items.splice(itemIndex, 1);
        // 添加到目标类部
        targetCategory.items.push(item);

        // 保存状态
        saveState();
        saveStateToStack(sourcePlan.id);
        saveStateToStack(targetPlan.id);

        // 关闭模态框
        document.getElementById('move-item-modal').style.display = 'none';

        // 刷新界面
        render();
    }

    // 请求删除膳品
    function requestDeleteItem(planId, categoryId, itemId) {
        deleteItem(planId, categoryId, itemId);
        // showConfirmModal('膳品取材千味，各有所益，还望陛下雨露均沾！', () => {
        // });
    }

    // 删除膳品
    function deleteItem(planId, categoryId, itemId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            const category = plan.categories.find(c => c.id === categoryId);
            if (category) {
                const index = category.items.findIndex(i => i.id === itemId);
                if (index !== -1) {
                    saveStateToStack(planId);
                    category.items.splice(index, 1);
                    saveState();
                    renderPlanDetails();
                }
            }
        }
    }

    // 保存状态到撤销栈
    function saveStateToStack(planId) {
        const plan = state.plans.find(p => p.id === planId);
        if (plan) {
            if (!state.undoStacks[planId]) {
                state.undoStacks[planId] = [];
            }

            // 保存当前状态的深拷贝
            state.undoStacks[planId].push(JSON.parse(JSON.stringify(plan)));

            // 限制栈大小
            if (state.undoStacks[planId].length > 500) {
                state.undoStacks[planId].shift();
            }

            // 清空重做栈
            state.redoStacks[planId] = [];
        }
    }

    // 撤销操作
    function undo(planId) {
        if (state.undoStacks[planId] && state.undoStacks[planId].length > 0) {
            const plan = state.plans.find(p => p.id === planId);
            if (plan) {
                // 保存当前状态到重做栈
                if (!state.redoStacks[planId]) {
                    state.redoStacks[planId] = [];
                }
                state.redoStacks[planId].push(JSON.parse(JSON.stringify(plan)));

                // 从撤销栈恢复状态
                const previousState = state.undoStacks[planId].pop();
                const index = state.plans.findIndex(p => p.id === planId);
                state.plans[index] = previousState;
                previousState.name = plan.name; // 方案名保持当前状态

                saveState();
                renderPlanSelector();
                renderPlanDetails();
            }
        }
    }

    // 重做操作
    function redo(planId) {
        if (state.redoStacks[planId] && state.redoStacks[planId].length > 0) {
            const plan = state.plans.find(p => p.id === planId);
            if (plan) {
                // 保存当前状态到撤销栈
                if (!state.undoStacks[planId]) {
                    state.undoStacks[planId] = [];
                }
                state.undoStacks[planId].push(JSON.parse(JSON.stringify(plan)));

                // 从重做栈恢复状态
                const nextState = state.redoStacks[planId].pop();
                const index = state.plans.findIndex(p => p.id === planId);
                state.plans[index] = nextState;
                nextState.name = plan.name; // 方案名保持当前状态

                saveState();
                renderPlanSelector();
                renderPlanDetails();
            }
        }
    }

    // 随机选择膳品
    function drawMeal(planId) {
        const plan = state.plans.find(p => p.id === planId);
        if (!plan) return;

        const results = {};
        let isValid = true;
        let errorMessage = '';

        // 对每个类部进行随机选择
        for (const category of plan.categories) {
            if (category.count === 0) continue; // 不选择

            // 检查不可重复时选择数量是否超过膳品种类
            if (!category.allowRepeat && category.count > category.items.length) {
                isValid = false;
                errorMessage = `陛下，类部"${category.name}"中的膳品不够了，膳品数(${category.items.length})比您要的不重复份数(${category.count})少`;
                break;
            }

            // 计算总权重
            const totalWeight = category.items.reduce((sum, item) => sum + item.weight, 0);
            if (totalWeight <= 0) {
                isValid = false;
                errorMessage = `陛下，类部"${category.name}"中没有有效权重的膳品`;
                break;
            }

            // 选择膳品
            const selectedItems = [];
            const availableItems = [...category.items]; // 可用膳品列表（用于不可重复的情况）

            for (let i = 0; i < category.count; i++) {
                if (availableItems.length === 0) break;

                // 随机选择
                let random = Math.random() * totalWeight;
                let selectedItem = null;

                for (const item of availableItems) {
                    random -= item.weight;
                    if (random <= 0) {
                        selectedItem = item;
                        break;
                    }
                }

                // 如果权重计算有问题，随机选择一个
                if (!selectedItem) {
                    selectedItem = availableItems[Math.floor(Math.random() * availableItems.length)];
                }

                selectedItems.push(selectedItem.name);

                // 如果不可重复，从可用列表中移除
                if (!category.allowRepeat) {
                    const index = availableItems.findIndex(item => item.id === selectedItem.id);
                    if (index !== -1) {
                        availableItems.splice(index, 1);
                    }
                }
            }

            results[category.name] = selectedItems;
        }

        if (!isValid) {
            alert(errorMessage);
            return;
        }

        // 显示结果
        showResultsModal(results, plan);
    }

    // 显示结果模态框
    function showResultsModal(results, plan) {
        currentResults = results;
        currentPlanForResults = plan;

        const resultContent = document.getElementById('result-content');
        resultContent.innerHTML = '';

        for (const [category, items] of Object.entries(results)) {
            if (items.length > 0) {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'result-item';
                categoryElement.innerHTML = `<strong>${category}:</strong> ${items.join(', ')}`;
                resultContent.appendChild(categoryElement);
            }
        }

        document.getElementById('result-modal').style.display = 'flex';
    }

    // 确认结果
    function confirmResult() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('note-modal').style.display = 'flex';
        document.getElementById('note-input').value = '';
    }

    // 保存备注
    function saveNote() {
        const note = document.getElementById('note-input').value;
        document.getElementById('note-modal').style.display = 'none';
        addToHistory(currentResults, note);
    }

    // 添加到历史记录
    function addToHistory(results, note) {
        state.history.push({
            id: generateId(),
            planId: currentPlanForResults.id,
            planName: currentPlanForResults.name,
            results: results,
            time: new Date().toISOString(),
            note: note
        });

        // 限制历史记录数量
        if (state.history.length > 1000) {
            state.history = state.history.slice(-1000);
        }

        saveState();
        render();
    }

    // 请求清除历史
    function requestClearHistory() {
        showConfirmModal('孤本圣注福泽万世，恳请陛下宽恕！', () => {
            clearHistory();
        });
    }

    // 清除历史
    function clearHistory() {
        state.history = [];
        saveState();
        render();
    }

    // 显示确认模态框
    function showConfirmModal(message, callback) {
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-modal').style.display = 'flex';
        confirmedCallback = callback;
    }

    // 执行确认的操作
    function executeConfirmedAction() {
        if (confirmedCallback) {
            confirmedCallback();
            confirmedCallback = null;
        }
        document.getElementById('confirm-modal').style.display = 'none';
    }

    // 生成唯一ID
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // 初始化应用
    window.onload = init;
</script>
</body>
</html>